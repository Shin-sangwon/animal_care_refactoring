<html layout:decorate="~{global/layout}">
<div class="container my-5" layout:fragment="content">
    <nav>
        <a href="/usr/mypage/doctor/hospital-info-manage" class="btn">뒤로</a>
    </nav>
    <h2 class="p-4">
        병원 선택
    </h2>
    <div class="row">
        <div class="col-2">
            <div id="hospital-list" class="list-group">
            </div>
        </div>
        <div class="col-10">
            <div id="map" style="width:100%; padding-bottom: 100%;"></div>
        </div>


        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <!--TODO appkey 비밀키 사용  -->
        <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=e11ec606a9ab5e56f6fcdae9c805b669&libraries=services"></script>
        <script th:inline="javascript">
            // 현재 의사의 경도 위도
            const {latitude, longitude} = [[${address}]];
            // 의사의 경도 위도 카카오 객체로 인스턴스화
            const myHomePosition = new kakao.maps.LatLng(latitude, longitude);
            // 지도 초기 설정
            const mapContainer = document.getElementById('map'), // 지도를 표시할 div
                mapOption = {
                    center: myHomePosition, // 지도의 중심좌표
                    level: 3 // 지도의 확대 레벨
                };

            const map = new kakao.maps.Map(mapContainer, mapOption); // 지도

            const myHomeMarker = new kakao.maps.Marker({
                map,
                title: "우리 집",
                position: myHomePosition ,
            });
            // TODO 우리 집 색상 바꾸기
            // 의사집 글자 마커위에 표시
            myHomeInfowindow = new kakao.maps.InfoWindow({
                content: "<div style='text-align: center'>우리 집</div>",
            });
            myHomeInfowindow.open(map, myHomeMarker);

            let infowindow; // 현재 표시되는 지역 정보 창
            let hospitals = [[${paging}]].content; // 현재 병원들
            let markers = []; // 현재 표시되는 마커
            let bounds = map.getBounds(); // 남서 동북 저장.
            let beforeBounds = map.getBounds(); // 지도 이동 이전 남서 동북 저장

            //Event
            // 타일 로드가 완료되면 지도 중심에 마커를 표시합니다
            kakao.maps.event.addListener(map, 'dragend', dragendCB);
            kakao.maps.event.addListener(map, 'zoom_changed', zoomChangedCB);
            // 초기 설정
            updateMarker()

            // paging된 값이 controller로 부터 넘어와야 한다.
            function dragendCB(){
                console.log('displayMarker');

                // 남서, 동북 정보 저장
                bounds =  map.getBounds();

                // 현재 정보
                // 영역정보의 남서쪽,  정보를 얻어옵니다
                const swLatlng = bounds.getSouthWest();
                // 영역정보의 북동쪽 정보를 얻어옵니다
                const neLatlng = bounds.getNorthEast();
                // 현재 맵의 중앙
                const centerLatlng= map.getCenter();

                // ajax 전 지도의 남서쪽 정보를 얻어옵니다
                const swLatlngBefore = beforeBounds.getSouthWest();
                // ajax 전 지도의 영역정보의 북동쪽 정보를 얻어옵니다
                const neLatlngBefore = beforeBounds.getNorthEast();

                // 현재 지도의 중앙이 변경 전 지도 안에 있다면 (지도를 조금만 움직였다면)
                // ajax 실행 X
                // 일단 보류
                // if(
                //     swLatlngBefore.La < centerLatlng.La && centerLatlng.La < neLatlngBefore.La &&
                //     swLatlngBefore.Ma < centerLatlng.Ma && centerLatlng.Ma < neLatlngBefore.Ma
                // ) return;

                console.log(swLatlng, neLatlng);
                console.log(centerLatlng);

                beforeBounds = map.getBounds();
                updateHospitalsUseAjax();
            }

            function zoomChangedCB(){
                console.log('map Level : ', map.getLevel());
                bounds =  map.getBounds();
                updateHospitalsUseAjax();
            }

            function changeHospitalPage(page){
                // 안내 창 삭제
                if(infowindow)
                    infowindow.close();
                updateHospitalsUseAjax(page);
            }

            async function updateHospitalsUseAjax(page = 0){
                try {
                    // 영역정보의 남서쪽,  정보를 얻어옵니다
                    const swLatlng = bounds.getSouthWest();
                    // 영역정보의 북동쪽 정보를 얻어옵니다
                    const neLatlng = bounds.getNorthEast();

                    // url 파라미터
                    const data = {
                        minLatitude: swLatlng.Ma,
                        maxLatitude: neLatlng.Ma,
                        minLongitude: swLatlng.La,
                        maxLongitude: neLatlng.La,
                        page
                    };
                    console.log(data);

                    /**
                     * hospitals 불러오기
                     */
                    const res = await $.ajax({
                        url: "/usr/hospital",
                        type: 'GET',
                        data
                    });
                    console.log(res);
                    // Pageable라는 가정으로 content 사용
                    hospitals = res.content;
                    $("#hospital-list")
                        .empty()
                        .append(
                            hospitals.map((hospital, index) =>
                                `<button type="button" onclick=panToBy(${index}) class="list-group-item list-group-item-action">
                                    ${hospital.name}
                                </button>`
                            )
                        )
                        .append(
                            res.empty ? '' :
                           ` <div>
                                <ul class="pagination justify-content-center">
                                    <li class="page-item ${res.first ? 'disabled' : ''}" ">
                                        <button class="page-link"
                                           th:href="@{|?page=${res.number- 1}|}"
                                           onclick=changeHospitalPage(${res.number - 1})>
                                            <span>이전</span>
                                        </button>
                                    </li>
                                    <li>
                                        ${res.number + 1} / ${res.totalPages}
                                    </li>
                                    <li class="page-item ${res.last ? 'disabled' : ''}">
                                        <button class="page-link"
                                        onclick=changeHospitalPage(${res.number + 1})>
                                            <span>다음</span>
                                        </button>
                                    </li>
                                </ul>
                            </div>`
                        );
                    updateMarker();
                } catch (err){
                    console.error(err);
                }
            }

            function updateMarker() {

                // 배열에 추가된 마커들을 삭제한다.
                for (const marker of markers) {
                    marker.setMap(null);
                }
                markers = [];

                // hospitals에 있는 장소들을 추가한다.
                hospitals.forEach((hospital) => {
                    const {address} = hospital;
                    // 위도, 경도 표시
                    // 없다면 주소로 위도 경도 제작.
                    const position = new kakao.maps.LatLng(address.latitude, address.longitude);
                    console.log(position);
                    // 마커를 생성합니다
                    const marker = new kakao.maps.Marker({
                        map,
                        title: hospital.name,
                        position,
                    });

                    // markers에 저장.
                    markers.push(marker);

                    // 마커를 클릭했을 때 마커 위에 표시할 인포윈도우를 생성합니다
                    const content =
                        '<div class="card">' +
                        '    <div class="info">' +
                        '        <div class="card-header">' +
                        hospital.name +
                        '            <div class="close" onclick="closeOverlay()" title="닫기"></div>' +
                        '        </div>' +
                        '        <div class="card-body">' +
                        '            <div class="desc">' +
                        '                <p>' + address.street + address.detail + '</p>' +
                        '            </div>' +
                        '            <div class="container">' +
                        '               <a class="btn btn-primary" href="https://www.kakaocorp.com/main"  target="_blank" class="link">홈페이지</a>' +
                        '               <a class="btn btn-primary" href="https://www.kakaocorp.com/main"  target="_blank" class="link">가입하기</a>' +
                        '           </div>' +
                        '        </div>' +
                        '    </div>' +
                        '</div>';

                    // 마커에 클릭이벤트를 등록합니다
                    kakao.maps.event.addListener(marker, 'click', function () {
                        if(infowindow)
                            infowindow.close();
                        // 인포윈도우를 생성합니다
                        console.log('click');
                        infowindow = new kakao.maps.InfoWindow({
                            content,
                            removable: true // removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다
                        });
                        // 마커 위에 인포윈도우를 표시합니다
                        infowindow.open(map, marker);
                    });
                })
                console.log('updateMarker markers : ',markers)
            }

            // 지도 이동
            function panToBy(index) {
                const hospital = hospitals[index];
                const marker = markers[index];
                console.log(hospital)
                const {latitude, longitude, street, detail} = hospital.address;

                // 이동할 위도 경도 위치를 생성합니다
                const position = new kakao.maps.LatLng(latitude,longitude);
                // 지도 중심을 부드럽게 이동시킵니다
                // 만약 이동할 거리가 지도 화면보다 크면 부드러운 효과 없이 이동합니다
                map.panTo(position);

                // 마크 생성

                // 마커를 클릭했을 때 마커 위에 표시할 인포윈도우를 생성합니다
                const content =
                    '<div class="card">' +
                    '    <div class="info">' +
                    '        <div class="card-header">' +
                    hospital.name  +
                    '            <div class="close" onclick="closeOverlay()" title="닫기"></div>' +
                    '        </div>' +
                    '        <div class="card-body">' +
                    '            <div class="desc">' +
                    '                <div class="ellipsis"></div>' +
                    '                <div class="jibun ellipsis">' + street + ' '+ detail +'</div>' +
                    '            </div>' +
                    '            <div class="container">' +
                    '               <a class="btn btn-primary" href="https://www.kakaocorp.com/main"  target="_blank" class="link">홈페이지</a>' +
                    '               <a class="btn btn-primary" href="https://www.kakaocorp.com/main"  target="_blank" class="link">가입하기</a>' +
                    '           </div>' +
                    '        </div>' +
                    '    </div>' +
                    '</div>';

                if(infowindow)
                    infowindow.close();

                infowindow = new kakao.maps.InfoWindow({
                    content : content,
                    removable : true // removeable 속성을 ture 로 설정하면 인포윈도우를 닫을 수 있는 x버튼이 표시됩니다
                });
                // 마커 위에 인포윈도우를 표시합니다
                infowindow.open(map, marker);
            }


        </script>
    </div>
</div>
</html>
